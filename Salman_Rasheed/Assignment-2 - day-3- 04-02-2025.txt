import streamlit as st
import json, re
from pathlib import Path
from openai import OpenAI

# ========== CONFIG ==========
st.set_page_config(page_title="Salman AI Assistant", layout="wide")

ROOT = Path.cwd()
CHAT_DIR = ROOT / "chats"
SEC_DIR = ROOT / "security"
API_FILE = SEC_DIR / "api_key.txt"

CHAT_DIR.mkdir(exist_ok=True)
SEC_DIR.mkdir(exist_ok=True)

MODEL = "openai/gpt-oss-120b"
BASE_URL = "https://openrouter.ai/api/v1"

# ========== DEFAULT SETTINGS ==========
DEFAULTS = {
    "theme": "Dark",
    "language": "English",
    "tone": "Friendly"
}

for k, v in DEFAULTS.items():
    st.session_state.setdefault(k, v)

st.session_state.setdefault("messages", [])
st.session_state.setdefault("current_file", None)

# ========== APPLY THEME ==========

if st.session_state.theme == "Dark":
    st.markdown("""
    <style>
    :root {
        --main-bg:#0f1720;
        --sidebar-bg:#16202b;
        --text-color:#e6eef8;
        --user-bg:#1f2a36;
        --bot-bg:#2b3340;
    }
    </style>
    """, unsafe_allow_html=True)
else:
    st.markdown("""
    <style>
    :root {
        --main-bg:#ffffff;
        --sidebar-bg:#f0f2f6;
        --text-color:#000000;
        --user-bg:#e9eef5;
        --bot-bg:#f6f8fb;
    }
    </style>
    """, unsafe_allow_html=True)

# ================= GLOBAL CSS =================
st.markdown("""
<style>

html, body, .stApp, [data-testid="stAppViewContainer"],
[data-testid="stHeader"], [data-testid="stToolbar"],
[data-testid="stDecoration"], section.main,
[data-testid="stBottomBlockContainer"] {
    background-color: var(--main-bg) !important;
    color: var(--text-color) !important;
}

[data-testid="stSidebar"] {
    background-color: var(--sidebar-bg) !important;
}

[data-testid="stSidebar"] label,
[data-testid="stSidebar"] span,
[data-testid="stSidebar"] p,
[data-testid="stSidebar"] div,
[data-testid="stSidebar"] button {
    color: black !important;
    font-weight:600;
}

[data-testid="stChatInput"] textarea {
    background:white !important;
    color:black !important;
    border-radius:12px !important;
}

.chat-user {
    background:var(--user-bg);
    color:var(--text-color);
    padding:12px;
    border-radius:12px;
    margin-bottom:8px;
    max-width:65%;
    margin-left:auto;
}

.chat-assistant {
    background:var(--bot-bg);
    color:var(--text-color);
    padding:12px;
    border-radius:12px;
    margin-bottom:8px;
    max-width:65%;
    margin-right:auto;
}

</style>
""", unsafe_allow_html=True)



# ========== OPENAI ==========
client = OpenAI(base_url=BASE_URL, api_key=API_FILE.read_text().strip())

def ask_ai(msgs):
    system = {
        "role": "system",
        "content": f"Respond in {st.session_state.language}. Tone: {st.session_state.tone}"
    }
    return client.chat.completions.create(model=MODEL, messages=[system]+msgs).choices[0].message.content

# ========== HELPERS ==========
def slugify(text):
    words = text.split()[:5]
    return re.sub(r"[^\w]+", "-", " ".join(words)).strip("-")

def save_chat():
    if not st.session_state.current_file:
        st.session_state.current_file = slugify(st.session_state.messages[0]["content"])
    (CHAT_DIR / st.session_state.current_file).write_text(json.dumps(st.session_state.messages))

# ========== SIDEBAR ==========
with st.sidebar:
    st.title("üí¨ Conversations")

    if st.button("‚ûï New Chat"):
        st.session_state.messages = []
        st.session_state.current_file = None
        st.rerun()

    st.subheader("Chat History")
    for f in CHAT_DIR.iterdir():
        c1, c2 = st.columns([4,1])
        with c1:
            if st.button(f.name):
                st.session_state.messages = json.loads(f.read_text())
                st.session_state.current_file = f.name
                st.rerun()
        with c2:
            if st.button("üóë", key=f.name):
                f.unlink()
                st.rerun()

    st.markdown("---")
    st.subheader("‚öô Settings")

    # TEMP SETTINGS (not applied yet)
    temp_theme = st.selectbox("Theme", ["Dark","Light"], index=["Dark","Light"].index(st.session_state.theme))
    temp_lang = st.selectbox("Language", ["English","Arabic","Urdu"], index=["English","Arabic","Urdu"].index(st.session_state.language))
    temp_tone = st.selectbox("Assistant Tone", ["Friendly","Professional","Technical"], index=["Friendly","Professional","Technical"].index(st.session_state.tone))

    col1, col2 = st.columns(2)

    if col1.button("üíæ Save"):
        st.session_state.theme = temp_theme
        st.session_state.language = temp_lang
        st.session_state.tone = temp_tone
        st.rerun()

    if col2.button("üîÑ Reset"):
        for k, v in DEFAULTS.items():
            st.session_state[k] = v
        st.rerun()

    if st.button("üóë Clear Current Chat"):
        st.session_state.messages = []
        st.session_state.current_file = None
        st.rerun()

# ========== MAIN ==========
st.title("ü§ñ Salman AI Assistant")

for m in st.session_state.messages: 
    if m["role"] == "user":
        st.markdown(f'<div class="chat-user">üßë‚Äçüíª You<br>{m["content"]}</div>', unsafe_allow_html=True)
    else:
        st.markdown(f'<div class="chat-assistant">ü§ñ Assistant<br>{m["content"]}</div>', unsafe_allow_html=True)


prompt = st.chat_input("What would you like to know?")
if prompt:
    st.session_state.messages.append({"role":"user","content":prompt})
    reply = ask_ai(st.session_state.messages)
    st.session_state.messages.append({"role":"assistant","content":reply})
    save_chat()
    st.rerun()
